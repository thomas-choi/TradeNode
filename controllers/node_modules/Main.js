// JScript source code
var   express = require('express');
var   app = express.createServer()
var   io = require('socket.io').listen(app);

var SM = require('./SubMgr');
var S1 = require('./Strategy');
var S2 = require('./Strategy2');
var SL = require('./StopLoss');
var APL = require('./Log');
var EM = require('./execMgr');
var PL = require('./PositionMgr');
var SLdesc = new Object(SL.StrategyParm);
var DataCenterT = false;
var StressT = false;
var MC = 'V1';
var Sim = false;

// command line : node.js main.js [-S]Stress test [-D]connect Data Center
process.argv.forEach(function (val, index, array) {
    switch (val) {
    case '-D':  DataCenterT = true; break;
    case '-T':  StressT = true; break; 
    case '-S':  Sim = true; break;  
    default:
   }    
   console.log(index + ': ' + val);
});

APL.initlog('TradeEngine', '1.0.0.1');           // init Log
APL.initdump('TradeEngine', '1.0.0.1');       // init Dump
APL.inittrade('TradeEngine', '1.0.0.1');       // init trade file

EM.start(9008, 'localhost');             // start up Execution Mgr
PL.start();              // start up Position Mgr
SLdesc.symbol = 'HSI'+MC;
SLdesc.stopGain = 20;
SLdesc.stopLoss = -7;
SLdesc.interval = 60;
SLdesc.exch = 'HKFE.HSI';
SL.start(SLdesc);         // start up StopLoss strategy

if (Sim) {               // simulation mode - read/replay data file
    SM.startSim();
} else if (DataCenterT) {   // start up Subcribe Mgr
    SM.start(9102, '203.86.131.35');
} else {
    SM.start(9101, 'localhost');
} 
if (StressT) {
    S1.start('MHI'+MC);
    S2.start('HHI'+MC);
} 

http.createServer(function (req, res) {
    res.writeHead(200, {'Content-Type': 'text/plain'});
    res.write('The number is ');
    for (i=0; i<=10; i++) {
        res.write(i+';');
    }
    res.end('Hello World ended\n');
    
}).listen(8080, "127.0.0.1");

console.log('Server running at http://127.0.0.1:8080/');
