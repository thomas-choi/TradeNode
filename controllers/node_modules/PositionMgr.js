// JScript source code
var net = require('net');
var util = require('util');
var APL = require('./Log');
var Port = require('./Portfolio');
var ORD = require('./Order');
var evt = null;
var logger = null;

function OrderAckHandler(order) {
    logger.debug('PositionMgr: OrderAckHandler='+APL.toStr(order));
 
    var    pt = Port.getPortfolio(order.account);
    var    origOrder = ORD.getOrder(order.ID);
    if (origOrder) {
        logger.debug('origOrder = ' + APL.toStr(origOrder));
        pt.adjustPos(origOrder.symbol, origOrder.filled*origOrder.bs, origOrder.filled*origOrder.avgPx*origOrder.bs*(-1));
    } 
    pt.adjustPos(order.symbol, order.filled*order.bs*(-1), order.filled*order.avgPx*order.bs);
    evt .emit('Pos', pt);     
}

function start(CE, log) { 
    logger = log;
    logger.info('PositionMgr started');
    evt = CE; 
    evt.on('ordack', OrderAckHandler);
    Port.init(log); 
}

module.exports.start = start;
